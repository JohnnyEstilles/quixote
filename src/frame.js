// Copyright (c) 2014 Titanium I.T. LLC. All rights reserved. For license, see "README" or "LICENSE" file.
"use strict";

var ensure = require("./util/ensure.js");
var QElement = require("./q_element.js");

var Me = module.exports = function Frame(domElement) {
	ensure.signature(arguments, [ Object ]);
	ensure.that(domElement.tagName === "IFRAME", "DOM element must be an iframe");

	this._domElement = domElement;
	this._document = domElement.contentDocument;
	this._originalBody = this._document.body.innerHTML;
};

Me.create = function create(parentElement, width, height, options, callback) {
	ensure.signature(arguments, [ Object, Number, Number, [ Object, Function ], [ undefined, Function ] ]);

	if (callback === undefined) {
		callback = options;
		options = {};
	}

	var iframe = document.createElement("iframe");
	addLoadListener(iframe, onFrameLoad);
	iframe.setAttribute("width", width);
	iframe.setAttribute("height", height);
	if (options.src) iframe.setAttribute("src", options.src);
	parentElement.appendChild(iframe);

	function onFrameLoad() {
		callback(new Me(iframe));
	}
};

Me.prototype.reset = function() {
	ensure.signature(arguments, []);

	this._document.body.innerHTML = this._originalBody;
};

Me.prototype.toDomElement = function() {
	ensure.signature(arguments, []);

	return this._domElement;
};

Me.prototype.remove = function() {
	ensure.signature(arguments, []);

	this._domElement.parentNode.removeChild(this._domElement);
};

Me.prototype.loadStylesheet = function(url, callback) {
	ensure.signature(arguments, [ String, Function ]);

	var link = document.createElement("link");
	addLoadListener(link, onLinkLoad);
	link.setAttribute("rel", "stylesheet");
	link.setAttribute("type", "text/css");
	link.setAttribute("href", url);

	documentHead(this).appendChild(link);

	function onLinkLoad() {
		callback();
	}
};

Me.prototype.addElement = function(html) {
	ensure.signature(arguments, [ String ]);

	var tempElement = document.createElement("div");
	tempElement.innerHTML = html;
	ensure.that(
		tempElement.childNodes.length === 1,
		"Expected one element, but got " + tempElement.childNodes.length + " (" + html + ")"
	);

	var insertedElement = tempElement.childNodes[0];
	this._document.body.appendChild(insertedElement);
	return new QElement(insertedElement);
};

Me.prototype.getElement = function(selector) {
	ensure.signature(arguments, [ String ]);

	var nodes = this._document.querySelectorAll(selector);
	ensure.that(nodes.length === 1, "Expected one element to match '" + selector + "', but found " + nodes.length);
	return new QElement(nodes[0]);
};

// WORKAROUND IE8: no addEventListener()
function addLoadListener(iframeDom, callback) {
	if (iframeDom.addEventListener) iframeDom.addEventListener("load", callback);
	else iframeDom.attachEvent("onload", callback);
}

// WORKAROUND IE8: no document.head
function documentHead(self) {
	if (self._document.head) return self._document.head;
	else return self._document.querySelector("head");
}